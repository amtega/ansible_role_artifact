---
# Tasks for testing role

- name: Configure docker sandbox environment
  hosts: localhost
  roles:
    - role: amtega.docker_presets
      docker_presets_images_json_query: >-
        [? starts_with(name, `centos-6`)
           || starts_with(name, `centos-7`)
           || starts_with(name, `fedora-29`)
           || starts_with(name, `fedora-30`) ]
  tags:
    - sandbox

- name: Run idempotence test
  hosts: localhost
  roles:
    - role: amtega.docker_sandbox
      docker_sandbox_state: started
  tags:
    - sandbox

- name: Prepare docker containers for test
  hosts: docker_sandbox_containers
  tasks:
    - name: Setup maven artifact
      set_fact:
        artifact_maven:
          id: maven
          type: maven
          artifact_id: spring-jdbc
          group_id: org.springframework
          host: http://central.maven.org
          path: /maven2
          version: 5.1.5.RELEASE
          dest: /tmp
          validate_certs: false
          no_log: no

    - name: Setup jenkins artifact
      set_fact:
        artifact_jenkins:
          - id: jenkins
            type: jenkins
            host: "{{ artifact_tests_jenkins_host }}"
            jenkins_path: >-
              {{ artifact_tests_jenkins_jenkins_path | default('/') }}
            job_name: "{{ artifact_tests_jenkins_job_name }}"
            path: "{{ artifact_tests_jenkins_path | default('/') }}"
            file: "{{ artifact_tests_jenkins_file }}"
            username: "{{ artifact_tests_jenkins_username | default(omit) }}"
            password: "{{ artifact_tests_jenkins_password | default(omit) }}"
            dest: /tmp
            validate_certs: false
            no_log: no
      when:
        - artifact_tests_jenkins_host is defined
        - artifact_tests_jenkins_jenkins_path is defined
        - artifact_tests_jenkins_job_name is defined
        - artifact_tests_jenkins_path is defined
        - artifact_tests_jenkins_file is defined
  tags:
    - idempotence

- name: Test artifact role present state
  hosts: docker_sandbox_containers
  roles:
    - amtega.artifact
  vars:
    artifact_load_from_hostvars: yes
    artifact_list:
      - id: gitlab
        type: gitlab
        host: https://gitlab.com
        project: demo-group/gitlab-ce
        branch: master
        file: README.md
        dest: /tmp
        validate_certs: false
        timeout: 180
        no_log: no

      - id: ansible
        type: github
        host: https://github.com
        project: amtega/ansible_role_artifact
        branch: master
        file: README.md
        dest: /tmp
        validate_certs: false
        no_log: no

      - id: tomcat1
        type: https
        host: https://archive.apache.org
        path: /dist/tomcat/tomcat-8/v8.5.9/bin
        file: apache-tomcat-8.5.9.tar.gz
        dest_file: tomcat.tar.gz
        checksum_algorithm: sha1
        checksum: 3c800e7affdf93bf4dbcf44bd852904449b786f6
        dest: /tmp
        unarchive: yes
        unarchive_creates: /tmp/apache-tomcat-8.5.9
        unarchive_remove: yes
        validate_certs: false
        no_log: no

      - id: tomcat2
        type: https
        host: https://archive.apache.org
        path: /dist/tomcat/tomcat-8/v8.5.9/bin
        file: apache-tomcat-8.5.9.tar.gz
        dest_file: tomcat2.tar.gz
        dest: /tmp
        validate_certs: false
        no_log: no

      - id: tomcat3
        type: https
        host: https://archive.apache.org
        path: /dist/tomcat/tomcat-8/v8.5.9/bin
        file: apache-tomcat-8.5.9.tar.gz
        dest_file: tomcat2.tar.gz
        dest: /tmp
        validate_certs: false
        no_log: no
  tasks:
    - name: Check gitlab artifact download
      stat:
        path: /tmp/README.md
      register: check_gitlab_result

    - name: Check github artifact download
      stat:
        path: /tmp/README.md
      register: check_github_result

    - name: Check http/https unarchived artifact download
      stat:
        path: /tmp/tomcat.tar.gz
      register: check_http_result

    - name: Check http/https artifact download
      stat:
        path: /tmp/tomcat2.tar.gz
      register: check_http2_result

    - name: Check http/https artifact unarchived content
      stat:
        path: /tmp/apache-tomcat-8.5.9
      register: check_http_unarchive_result

    - name: Check jenkins artifact download
      stat:
        path: >-
          {{ "/tmp/"
             + artifact.artifact_id
             + "-"
             + artifact.version
             + "."
             + artifact.extension }}
      register: check_jenkins_result
      vars:
        artifact: "{{ artifact_jenkins.0 }}"
      when:
        - artifact_tests_jenkins_host is defined
        - artifact_tests_jenkins_job_name is defined
        - artifact_tests_jenkins_artifact_id is defined
        - artifact_tests_jenkins_version is defined
        - artifact_tests_jenkins_extension is defined

    - name: Check maven artifact download
      stat:
        path: /tmp/spring-jdbc-5.1.5.RELEASE.jar
      register: check_maven_result

    - name: Check that artifacts were downloaded correctly
      assert:
        that:
          - check_gitlab_result.stat.exists
          - check_github_result.stat.exists
          - not check_http_result.stat.exists
          - check_http2_result.stat.exists
          - check_http_unarchive_result.stat.exists
          - check_maven_result.stat.exists
          - artifact_result.gitlab is defined
          - artifact_result.ansible is defined
          - artifact_result.tomcat1 is defined
          - artifact_result.maven is defined
          - not artifact_result.tomcat3.changed

    - name: Check that jenkins artifacts were downloaded correctly
      assert:
        that:
          - check_jenkins_result.stat.exists
          - artifact_result.jenkins is defined
      when:
        - artifact_tests_jenkins_host is defined
        - artifact_tests_jenkins_job_name is defined
        - artifact_tests_jenkins_artifact_id is defined
        - artifact_tests_jenkins_version is defined
        - artifact_tests_jenkins_extension is defined
  tags:
    - idempotence

- name: Test artifact role absent state
  hosts: docker_sandbox_containers
  roles:
    - amtega.artifact
  vars:
    artifact_load_from_hostvars: yes
    artifact_list:
      - id: tomcat1
        type: https
        host: https://archive.apache.org
        path: /dist/tomcat/tomcat-8/v8.5.9/bin
        file: apache-tomcat-8.5.9.tar.gz
        dest_file: tomcat.tar.gz
        checksum_algorithm: sha1
        checksum: 3c800e7affdf93bf4dbcf44bd852904449b786f6
        dest: /tmp
        unarchive: yes
        unarchive_creates: /tmp/apache-tomcat-8.5.9
        validate_certs: false
        state: absent
        no_log: no
  tasks:
    - name: Check http/https artifact download
      stat:
        path: /tmp/apache-tomcat-8.5.9.tar.gz
      register: check_http_result

    - name: Check http/https artifact unarchived content
      stat:
        path: /tmp/apache-tomcat-8.5.9
      register: check_http_unarchive_result

    - name: Check that artifacts were removed correctly
      assert:
        that:
          - not check_http_result.stat.exists
          - not check_http_unarchive_result.stat.exists
          - artifact_result.tomcat1 is defined
          - artifact_result.tomcat1.changed

- name: Cleanup docker sandbox
  hosts: localhost
  roles:
    - role: amtega.docker_sandbox
      docker_sandbox_state: absent
  tags:
    - cleanup
    - sandbox
